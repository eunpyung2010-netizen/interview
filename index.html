<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI ë©´ì ‘ ë¶„ì„ ì‹œìŠ¤í…œ</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Noto Sans KR', sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); color: #e8e8e8; min-height: 100vh; }
    .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
    header { text-align: center; padding: 2rem 0; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 2rem; }
    header h1 { font-size: 2rem; font-weight: 700; background: linear-gradient(135deg, #3B82F6, #60A5FA); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem; }
    header p { color: #888; }
    .tabs { display: flex; justify-content: center; gap: 0.5rem; margin-bottom: 2rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 1rem; }
    .tab-btn { padding: 0.75rem 1.5rem; background: transparent; border: none; color: #888; cursor: pointer; font-size: 1rem; font-weight: 500; border-bottom: 3px solid transparent; transition: all 0.3s; }
    .tab-btn:hover { color: #ccc; }
    .tab-btn.active { color: #3B82F6; border-bottom-color: #3B82F6; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; }
    .card h2 { font-size: 1.25rem; margin-bottom: 1rem; }
    input, textarea, select { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 0.75rem 1rem; color: #e8e8e8; font-size: 0.95rem; width: 100%; font-family: inherit; }
    input:focus, textarea:focus { outline: none; border-color: #3B82F6; }
    label { display: block; margin-bottom: 0.35rem; color: #888; font-size: 0.85rem; }
    .btn { padding: 0.75rem 1.5rem; border-radius: 12px; font-weight: 500; cursor: pointer; border: none; font-size: 0.95rem; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.3s; }
    .btn-primary { background: linear-gradient(135deg, #3B82F6, #2563EB); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(59,130,246,0.4); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-secondary { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; }
    .btn-danger { background: linear-gradient(135deg, #EF4444, #DC2626); color: white; }
    .btn-sm { padding: 0.5rem 1rem; font-size: 0.85rem; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 1rem; text-align: left; }
    th { background: rgba(0,0,0,0.3); color: #aaa; font-size: 0.9rem; }
    tr { border-bottom: 1px solid rgba(255,255,255,0.05); }
    .status-badge { padding: 0.35rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
    .status-waiting { background: rgba(107,114,128,0.2); color: #9CA3AF; }
    .status-recording { background: rgba(239,68,68,0.2); color: #EF4444; }
    .status-converting { background: rgba(245,158,11,0.2); color: #F59E0B; }
    .status-analyzing { background: rgba(59,130,246,0.2); color: #3B82F6; }
    .status-completed { background: rgba(16,185,129,0.2); color: #10B981; }
    .status-error { background: rgba(239,68,68,0.2); color: #EF4444; }
    .type-ì¼ë°˜ { background: rgba(59,130,246,0.2); color: #3B82F6; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; }
    .type-ë°œí‘œ { background: rgba(168,85,247,0.2); color: #A855F7; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; }
    .alert { padding: 1rem; border-radius: 12px; margin-bottom: 1rem; display: flex; align-items: start; gap: 0.75rem; }
    .alert-error { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: #EF4444; }
    .alert-success { background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3); color: #10B981; }
    .alert-warning { background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); color: #F59E0B; }
    .alert-info { background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.2); color: #93C5FD; }
    .recording-dot { width: 12px; height: 12px; background: #EF4444; border-radius: 50%; display: inline-block; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .delete-btn { background: transparent; border: none; color: #666; cursor: pointer; padding: 0.5rem; }
    .delete-btn:hover { color: #EF4444; }
    .competency-item { display: grid; grid-template-columns: 40px 200px 1fr 40px; gap: 1rem; align-items: start; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 12px; margin-bottom: 1rem; }
    .competency-num { width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #3B82F6, #60A5FA); display: flex; align-items: center; justify-content: center; font-weight: 600; }
    .result-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
    .result-card { padding: 1.25rem; background: rgba(0,0,0,0.2); border-radius: 12px; cursor: pointer; border: 2px solid transparent; transition: all 0.3s; }
    .result-card:hover { background: rgba(0,0,0,0.3); }
    .result-card.selected { border-color: #3B82F6; }
    .analysis-section { margin-bottom: 2rem; padding: 1.5rem; background: rgba(0,0,0,0.2); border-radius: 12px; }
    .analysis-section h3 { font-size: 1.2rem; color: #60A5FA; margin-bottom: 1.25rem; }
    .evidence { color: #888; font-size: 0.9rem; padding-left: 1rem; border-left: 2px solid; margin-top: 0.35rem; }
    .manual-form { display: none; }
    .manual-form.show { display: block; }
    @media (max-width: 768px) { .competency-item { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ¯ AI ë©´ì ‘ ë¶„ì„ ì‹œìŠ¤í…œ</h1>
      <p>ë©´ì ‘ ë…¹ìŒ â†’ ìŒì„± ë³€í™˜ â†’ AI ì—­ëŸ‰ ë¶„ì„ â†’ í”¼ë“œë°± ìƒì„±</p>
    </header>
    
    <div class="tabs">
      <button class="tab-btn active" onclick="showTab('settings')">âš™ï¸ ì„¤ì •</button>
      <button class="tab-btn" onclick="showTab('candidates')">ğŸ‘¥ ì§€ì›ì ê´€ë¦¬</button>
      <button class="tab-btn" onclick="showTab('results')">ğŸ“„ ê²°ê³¼ í™•ì¸</button>
    </div>
    
    <div id="settings" class="tab-content active">
      <div class="card">
        <h2>ğŸ”‘ API ì„¤ì •</h2>
        <div style="margin-bottom: 1rem;">
          <label>OpenAI API Key (Whisper ìŒì„± ì¸ì‹ìš©)</label>
          <input type="password" id="openaiKey" placeholder="sk-..." style="max-width: 500px;">
          <p style="font-size: 0.8rem; color: #666; margin-top: 0.5rem;">* ìŒì„±ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜í•˜ëŠ”ë° ì‚¬ìš©ë©ë‹ˆë‹¤.</p>
        </div>
      </div>
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
          <h2>ğŸ“‹ í‰ê°€ ì—­ëŸ‰ ì„¤ì •</h2>
          <button class="btn btn-primary" onclick="addCompetency()">â• ì—­ëŸ‰ ì¶”ê°€</button>
        </div>
        <div id="competencyList"></div>
      </div>
    </div>
    
    <div id="candidates" class="tab-content">
      <div class="card" style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
          <label class="btn btn-primary" style="cursor: pointer;">
            ğŸ“ CSV ì—…ë¡œë“œ
            <input type="file" id="csvUpload" accept=".csv" style="display: none;" onchange="handleCSV(event)">
          </label>
          <button class="btn btn-secondary" onclick="toggleManual()">â• ìˆ˜ë™ ì¶”ê°€</button>
          <span style="color: #888; font-size: 0.85rem; align-self: center;">(ë©´ì ‘ë²ˆí˜¸, ì§€ì›ì§ë¬´, ë©´ì ‘í˜•ì‹)</span>
        </div>
        <button class="btn btn-secondary" onclick="downloadAll()" id="downloadAllBtn" disabled>ğŸ“¥ ì „ì²´ ë‹¤ìš´ë¡œë“œ</button>
      </div>
      
      <div class="card manual-form" id="manualForm">
        <h2>â• ì§€ì›ì ìˆ˜ë™ ì¶”ê°€</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
          <div><label>ë©´ì ‘ë²ˆí˜¸ *</label><input type="text" id="manualId" placeholder="ì˜ˆ: A001"></div>
          <div><label>ì§€ì›ì§ë¬´</label><input type="text" id="manualPos" placeholder="ì˜ˆ: ê°œë°œ"></div>
          <div><label>ë©´ì ‘í˜•ì‹</label><select id="manualType"><option value="ì¼ë°˜">ì¼ë°˜</option><option value="ë°œí‘œ">ë°œí‘œ</option></select></div>
          <div style="display: flex; gap: 0.5rem;"><button class="btn btn-primary" onclick="addManual()">ì¶”ê°€</button><button class="btn btn-secondary" onclick="toggleManual()">ì·¨ì†Œ</button></div>
        </div>
      </div>
      
      <div id="alertArea"></div>
      
      <div class="card" style="padding: 0; overflow: hidden;">
        <table>
          <thead><tr><th>ë©´ì ‘ë²ˆí˜¸</th><th>ì§€ì›ì§ë¬´</th><th>ë©´ì ‘í˜•ì‹</th><th style="text-align:center;">ìƒíƒœ</th><th style="text-align:center;">ì•¡ì…˜</th></tr></thead>
          <tbody id="candidateTable"></tbody>
        </table>
      </div>
    </div>
    
    <div id="results" class="tab-content">
      <div class="card">
        <h2>âœ… ë¶„ì„ ì™„ë£Œ ëª©ë¡ <span id="completedCount" class="status-badge status-completed">0ëª…</span></h2>
        <div id="resultGrid" class="result-grid"></div>
        <div id="noResults" style="text-align: center; padding: 3rem; color: #666;">ğŸ“„ ì•„ì§ ë¶„ì„ ì™„ë£Œëœ ì§€ì›ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>
      </div>
      <div class="card" id="resultDetail" style="display: none;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 2rem;">
          <div><h2 id="detailTitle"></h2><p id="detailSub" style="color: #888;"></p></div>
          <div style="display: flex; gap: 0.5rem;"><button class="btn btn-secondary" onclick="downloadOne('word')">ğŸ“„ Word</button><button class="btn btn-secondary" onclick="downloadOne('txt')">ğŸ“ TXT</button></div>
        </div>
        <div class="alert alert-info">â€» ë³¸ ë¶„ì„ì€ ë©´ì ‘ ì¤‘ ë‹µë³€ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ AIê°€ ì‘ì„±í•œ ì°¸ê³  ìë£Œì…ë‹ˆë‹¤.</div>
        <div id="analysisContent"></div>
      </div>
    </div>
  </div>

<script>
// ìƒíƒœ
let competencies = [
  { id: 1, name: 'ë¬¸ì œí•´ê²°ë ¥', definition: 'ì£¼ì–´ì§„ ìƒí™©ì—ì„œ ë…¼ë¦¬ì ìœ¼ë¡œ ë¬¸ì œë¥¼ ë¶„ì„í•˜ê³  í•´ê²°ì±…ì„ ì œì‹œí•˜ëŠ” ëŠ¥ë ¥' },
  { id: 2, name: 'ì˜ì‚¬ì†Œí†µ', definition: 'ìì‹ ì˜ ìƒê°ì„ ëª…í™•í•˜ê²Œ ì „ë‹¬í•˜ê³  ì§ˆë¬¸ì˜ ì˜ë„ë¥¼ íŒŒì•…í•˜ëŠ” ëŠ¥ë ¥' }
];
let candidates = [];
let currentRecId = null;
let mediaRecorder = null;
let audioChunks = [];
let recInterval = null;
let recTime = 0;
let selectedId = null;

const STATUS = { WAITING: 'waiting', RECORDING: 'recording', CONVERTING: 'converting', ANALYZING: 'analyzing', COMPLETED: 'completed', ERROR: 'error' };
const STATUS_TEXT = { waiting: 'ëŒ€ê¸°', recording: 'ë…¹ìŒì¤‘', converting: 'ë³€í™˜ì¤‘', analyzing: 'ë¶„ì„ì¤‘', completed: 'ì™„ë£Œ', error: 'ì˜¤ë¥˜' };

// ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
  renderCompetencies();
  renderCandidates();
});

// íƒ­ ì „í™˜
function showTab(id) {
  document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
  document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
  event.target.classList.add('active');
  document.getElementById(id).classList.add('active');
}

// ì—­ëŸ‰ ê´€ë¦¬
function renderCompetencies() {
  var list = document.getElementById('competencyList');
  if (competencies.length === 0) {
    list.innerHTML = '<div style="text-align:center;padding:3rem;color:#666;">ğŸ“‹ ì„¤ì •ëœ ì—­ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }
  var html = '';
  for (var i = 0; i < competencies.length; i++) {
    var c = competencies[i];
    html += '<div class="competency-item">';
    html += '<span class="competency-num">' + (i + 1) + '</span>';
    html += '<div><label>ì—­ëŸ‰ëª…</label><input type="text" value="' + c.name + '" onchange="updateComp(' + c.id + ',\'name\',this.value)"></div>';
    html += '<div><label>ì •ì˜</label><textarea rows="2" onchange="updateComp(' + c.id + ',\'definition\',this.value)">' + c.definition + '</textarea></div>';
    html += '<button class="delete-btn" onclick="deleteComp(' + c.id + ')">ğŸ—‘ï¸</button>';
    html += '</div>';
  }
  list.innerHTML = html;
}

function addCompetency() {
  var maxId = 0;
  for (var i = 0; i < competencies.length; i++) { if (competencies[i].id > maxId) maxId = competencies[i].id; }
  competencies.push({ id: maxId + 1, name: '', definition: '' });
  renderCompetencies();
}

function updateComp(id, field, value) {
  for (var i = 0; i < competencies.length; i++) {
    if (competencies[i].id === id) { competencies[i][field] = value; break; }
  }
}

function deleteComp(id) {
  competencies = competencies.filter(function(c) { return c.id !== id; });
  renderCompetencies();
}

// CSV ì²˜ë¦¬
function handleCSV(event) {
  var file = event.target.files[0];
  if (!file) return;
  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var text = e.target.result;
      var lines = text.split('\n').filter(function(l) { return l.trim(); });
      if (lines.length < 2) { showAlert('error', 'CSVì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
      var delim = lines[0].indexOf('\t') >= 0 ? '\t' : ',';
      var headers = parseCSVLine(lines[0], delim);
      var idIdx = -1, posIdx = -1, typeIdx = -1;
      for (var i = 0; i < headers.length; i++) {
        var h = headers[i].toLowerCase();
        if (h.indexOf('ë©´ì ‘ë²ˆí˜¸') >= 0 || h.indexOf('ë²ˆí˜¸') >= 0 || h.indexOf('id') >= 0) idIdx = i;
        if (h.indexOf('ì§€ì›ì§ë¬´') >= 0 || h.indexOf('ì§ë¬´') >= 0) posIdx = i;
        if (h.indexOf('ë©´ì ‘í˜•ì‹') >= 0 || h.indexOf('í˜•ì‹') >= 0) typeIdx = i;
      }
      if (idIdx < 0) { showAlert('error', 'ë©´ì ‘ë²ˆí˜¸ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì»¬ëŸ¼: ' + headers.join(', ')); return; }
      var count = 0;
      for (var i = 1; i < lines.length; i++) {
        var vals = parseCSVLine(lines[i], delim);
        var id = (vals[idIdx] || '').trim();
        if (!id) continue;
        var finalId = id;
        var suffix = 2;
        while (candidates.some(function(c) { return c.id === finalId; })) { finalId = id + '_' + suffix; suffix++; }
        candidates.push({
          id: finalId,
          position: (posIdx >= 0 ? vals[posIdx] : '').trim() || 'ë¯¸ì§€ì •',
          interviewType: (typeIdx >= 0 ? vals[typeIdx] : '').trim() || 'ì¼ë°˜',
          status: STATUS.WAITING, audioBlob: null, transcript: '', analysis: null, error: null
        });
        count++;
      }
      showAlert('success', count + 'ëª…ì˜ ì§€ì›ìê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
      renderCandidates();
    } catch (err) { showAlert('error', 'CSV íŒŒì‹± ì˜¤ë¥˜: ' + err.message); }
  };
  reader.readAsText(file, 'UTF-8');
  event.target.value = '';
}

function parseCSVLine(line, delim) {
  var result = [], current = '', inQuotes = false;
  for (var i = 0; i < line.length; i++) {
    var ch = line[i];
    if (ch === '"') inQuotes = !inQuotes;
    else if (ch === delim && !inQuotes) { result.push(current.trim()); current = ''; }
    else current += ch;
  }
  result.push(current.trim());
  return result;
}

// ìˆ˜ë™ ì¶”ê°€
function toggleManual() {
  document.getElementById('manualForm').classList.toggle('show');
}

function addManual() {
  var id = document.getElementById('manualId').value.trim();
  var pos = document.getElementById('manualPos').value.trim() || 'ë¯¸ì§€ì •';
  var type = document.getElementById('manualType').value;
  if (!id) { showAlert('error', 'ë©´ì ‘ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
  var finalId = id, suffix = 2;
  while (candidates.some(function(c) { return c.id === finalId; })) { finalId = id + '_' + suffix; suffix++; }
  candidates.push({ id: finalId, position: pos, interviewType: type, status: STATUS.WAITING, audioBlob: null, transcript: '', analysis: null, error: null });
  document.getElementById('manualId').value = '';
  document.getElementById('manualPos').value = '';
  toggleManual();
  showAlert('success', 'ì§€ì›ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.' + (finalId !== id ? ' (ì¤‘ë³µìœ¼ë¡œ ' + finalId + 'ë¡œ ë“±ë¡)' : ''));
  renderCandidates();
}

// ì§€ì›ì ë Œë”ë§
function renderCandidates() {
  var tbody = document.getElementById('candidateTable');
  if (candidates.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="padding:4rem;text-align:center;color:#666;">ğŸ‘¥ ë“±ë¡ëœ ì§€ì›ìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    return;
  }
  var html = '';
  for (var i = 0; i < candidates.length; i++) {
    var c = candidates[i];
    var bg = currentRecId === c.id ? 'background:rgba(239,68,68,0.1);' : '';
    html += '<tr style="' + bg + '">';
    html += '<td style="font-weight:500;">' + c.id + '</td>';
    html += '<td style="color:#aaa;">' + c.position + '</td>';
    html += '<td><span class="type-' + c.interviewType + '">' + c.interviewType + '</span></td>';
    html += '<td style="text-align:center;"><span class="status-badge status-' + c.status + '">';
    if (c.status === STATUS.RECORDING) html += '<span class="recording-dot"></span> ';
    if (c.status === STATUS.CONVERTING || c.status === STATUS.ANALYZING) html += 'â³ ';
    if (c.status === STATUS.COMPLETED) html += 'âœ… ';
    if (c.status === STATUS.ERROR) html += 'âŒ ';
    html += STATUS_TEXT[c.status];
    if (c.status === STATUS.RECORDING) html += ' ' + formatTime(recTime);
    html += '</span></td>';
    html += '<td style="text-align:center;"><div style="display:flex;gap:0.5rem;justify-content:center;">';
    if (c.status === STATUS.WAITING) {
      html += '<button class="btn btn-primary btn-sm" onclick="startRec(\'' + c.id + '\')"' + (currentRecId ? ' disabled' : '') + '>ğŸ™ï¸ ë…¹ìŒ</button>';
    }
    if (c.status === STATUS.RECORDING && currentRecId === c.id) {
      html += '<button class="btn btn-danger btn-sm" onclick="stopRec()">â¹ï¸ ì¢…ë£Œ</button>';
    }
    if (c.status === STATUS.COMPLETED) {
      html += '<button class="btn btn-secondary btn-sm" onclick="viewResult(\'' + c.id + '\')">ğŸ‘ï¸ ê²°ê³¼</button>';
    }
    if (c.status === STATUS.ERROR) {
      html += '<button class="btn btn-secondary btn-sm" onclick="retry(\'' + c.id + '\')" title="' + (c.error || '') + '">ğŸ”„ ì¬ì‹œë„</button>';
    }
    html += '<button class="delete-btn" onclick="deleteCand(\'' + c.id + '\')">ğŸ—‘ï¸</button>';
    html += '</div></td></tr>';
  }
  tbody.innerHTML = html;
  document.getElementById('downloadAllBtn').disabled = !candidates.some(function(c) { return c.status === STATUS.COMPLETED; });
  renderResults();
}

function deleteCand(id) {
  if (currentRecId === id) stopRec();
  candidates = candidates.filter(function(c) { return c.id !== id; });
  renderCandidates();
}

function retry(id) {
  var c = candidates.find(function(x) { return x.id === id; });
  if (c) { c.status = STATUS.WAITING; c.error = null; renderCandidates(); }
}

// ë…¹ìŒ
function startRec(id) {
  var apiKey = document.getElementById('openaiKey').value.trim();
  if (!apiKey) {
    showAlert('warning', 'OpenAI API Keyê°€ ì—†ìŠµë‹ˆë‹¤. ì„¤ì • íƒ­ì—ì„œ ì…ë ¥ í›„ ë…¹ìŒí•´ì£¼ì„¸ìš”.');
  }
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    showAlert('error', 'ì´ ë¸Œë¼ìš°ì €ëŠ” ë…¹ìŒì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    return;
  }
  navigator.mediaDevices.getUserMedia({ audio: true })
    .then(function(stream) {
      var mimeType = 'audio/webm';
      if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) mimeType = 'audio/webm;codecs=opus';
      else if (MediaRecorder.isTypeSupported('audio/mp4')) mimeType = 'audio/mp4';
      mediaRecorder = new MediaRecorder(stream, { mimeType: mimeType });
      audioChunks = [];
      mediaRecorder.ondataavailable = function(e) { if (e.data.size > 0) audioChunks.push(e.data); };
      mediaRecorder.onstop = function() {
        var blob = new Blob(audioChunks, { type: mimeType });
        var c = candidates.find(function(x) { return x.id === id; });
        if (c) { c.audioBlob = blob; c.status = STATUS.CONVERTING; }
        stream.getTracks().forEach(function(t) { t.stop(); });
        renderCandidates();
        processAudio(id, blob);
      };
      mediaRecorder.start(1000);
      currentRecId = id;
      recTime = 0;
      var c = candidates.find(function(x) { return x.id === id; });
      if (c) c.status = STATUS.RECORDING;
      recInterval = setInterval(function() { recTime++; renderCandidates(); }, 1000);
      renderCandidates();
      showAlert('success', 'ë…¹ìŒì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ™ï¸');
    })
    .catch(function(err) {
      var msg = 'ë§ˆì´í¬ ì ‘ê·¼ ì‹¤íŒ¨: ';
      if (err.name === 'NotAllowedError') msg += 'ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €ì—ì„œ ë§ˆì´í¬ë¥¼ í—ˆìš©í•´ì£¼ì„¸ìš”.';
      else if (err.name === 'NotFoundError') msg += 'ë§ˆì´í¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
      else msg += err.message;
      showAlert('error', msg);
    });
}

function stopRec() {
  if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
  if (recInterval) clearInterval(recInterval);
  currentRecId = null;
  recTime = 0;
}

function formatTime(s) {
  var m = Math.floor(s / 60);
  var sec = s % 60;
  return (m < 10 ? '0' : '') + m + ':' + (sec < 10 ? '0' : '') + sec;
}

// ìŒì„± ì²˜ë¦¬
function processAudio(id, blob) {
  var apiKey = document.getElementById('openaiKey').value.trim();
  var c = candidates.find(function(x) { return x.id === id; });
  if (!apiKey) {
    c.status = STATUS.ERROR;
    c.error = '[ìŒì„±ë³€í™˜ ì˜¤ë¥˜] OpenAI API Keyê°€ í•„ìš”í•©ë‹ˆë‹¤.';
    renderCandidates();
    showAlert('error', 'OpenAI API Keyê°€ í•„ìš”í•©ë‹ˆë‹¤. ì„¤ì • íƒ­ì—ì„œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  var formData = new FormData();
  formData.append('file', blob, 'recording.webm');
  formData.append('model', 'whisper-1');
  formData.append('language', 'ko');
  
  fetch('https://api.openai.com/v1/audio/transcriptions', {
    method: 'POST',
    headers: { 'Authorization': 'Bearer ' + apiKey },
    body: formData
  })
  .then(function(res) {
    if (!res.ok) throw new Error('[ìŒì„±ë³€í™˜ ì˜¤ë¥˜] Whisper API: ' + res.status);
    return res.json();
  })
  .then(function(data) {
    c.transcript = data.text;
    c.status = STATUS.ANALYZING;
    renderCandidates();
    return analyzeWithClaude(c.transcript, c.interviewType);
  })
  .then(function(analysis) {
    c.analysis = analysis;
    c.status = STATUS.COMPLETED;
    renderCandidates();
    showAlert('success', c.id + ' ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
  })
  .catch(function(err) {
    c.status = STATUS.ERROR;
    c.error = err.message;
    renderCandidates();
    showAlert('error', err.message);
  });
}

function analyzeWithClaude(transcript, interviewType) {
  var compList = '';
  for (var i = 0; i < competencies.length; i++) {
    compList += (i + 1) + '. ' + competencies[i].name + ': ' + competencies[i].definition + '\n';
  }
  var typeDesc = interviewType === 'ë°œí‘œ' ? 'ë°œí‘œ ë©´ì ‘ (ë°œí‘œ í›„ ì§ˆì˜ì‘ë‹µ)' : 'ì¼ë°˜ ì§ˆì˜ì‘ë‹µ ë©´ì ‘';
  var prompt = 'ë‹¹ì‹ ì€ ì±„ìš© ë©´ì ‘ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì•„ë˜ ë©´ì ‘ ë…¹ì·¨ë¡ì„ ë¶„ì„í•´ì£¼ì„¸ìš”.\n\n';
  prompt += '[ë©´ì ‘ í˜•ì‹] ' + typeDesc + '\n\n';
  prompt += '[ë…¹ì·¨ë¡]\n' + transcript + '\n\n';
  prompt += '[í‰ê°€ ì—­ëŸ‰]\n' + compList + '\n';
  prompt += 'ê° ì—­ëŸ‰ë³„ë¡œ ê°•ì ê³¼ ê°œì„ ì ì„ 2~3ê°œì”© ì œì‹œí•˜ê³ , ê·¼ê±°ë¥¼ í•¨ê»˜ ì‘ì„±í•´ì£¼ì„¸ìš”.\n';
  prompt += 'ê´€ì°°ë˜ì§€ ì•Šìœ¼ë©´ "ê´€ì°°ë˜ì§€ ì•ŠìŒ"ìœ¼ë¡œ í‘œê¸°í•˜ì„¸ìš”.\n';
  prompt += 'ë¶€ë“œëŸ¬ìš´ í†¤ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.\n\n';
  prompt += 'JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µ:\n';
  prompt += '{"competencies":[{"name":"ì—­ëŸ‰ëª…","strengths":[{"point":"ê°•ì ","evidence":"ê·¼ê±°"}],"improvements":[{"point":"ê°œì„ ì ","evidence":"ê·¼ê±°"}]}],"overallComment":"ì¢…í•©ì˜ê²¬"}\n';
  prompt += 'DO NOT OUTPUT ANYTHING OTHER THAN VALID JSON.';

  // Vercel API ë¼ìš°íŠ¸ë¥¼ í†µí•´ í˜¸ì¶œ (í™˜ê²½ë³€ìˆ˜ ì‚¬ìš©)
  return fetch('/api/analyze', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ prompt: prompt })
  })
  .then(function(res) {
    if (!res.ok) {
      return res.json().then(function(errData) {
        throw new Error('[ë¶„ì„ ì˜¤ë¥˜] ' + (errData.error || 'Claude API ì˜¤ë¥˜: ' + res.status));
      });
    }
    return res.json();
  })
  .then(function(data) {
    if (data.error) throw new Error('[ë¶„ì„ ì˜¤ë¥˜] ' + data.error);
    var text = data.content;
    text = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
    try {
      return JSON.parse(text);
    } catch (e) {
      throw new Error('[ë¶„ì„ ì˜¤ë¥˜] JSON íŒŒì‹± ì‹¤íŒ¨: ' + e.message);
    }
  });
}

// ê²°ê³¼ ë Œë”ë§
function renderResults() {
  var completed = candidates.filter(function(c) { return c.status === STATUS.COMPLETED; });
  document.getElementById('completedCount').textContent = completed.length + 'ëª…';
  var grid = document.getElementById('resultGrid');
  var noRes = document.getElementById('noResults');
  if (completed.length === 0) {
    grid.innerHTML = '';
    noRes.style.display = 'block';
    document.getElementById('resultDetail').style.display = 'none';
    return;
  }
  noRes.style.display = 'none';
  var html = '';
  for (var i = 0; i < completed.length; i++) {
    var c = completed[i];
    var sel = selectedId === c.id ? ' selected' : '';
    html += '<div class="result-card' + sel + '" onclick="viewResult(\'' + c.id + '\')">';
    html += '<div style="display:flex;justify-content:space-between;">';
    html += '<div><div style="font-weight:600;font-size:1.1rem;">' + c.id + '</div><div style="color:#888;font-size:0.9rem;">' + c.position + '</div></div>';
    html += '<span class="type-' + c.interviewType + '">' + c.interviewType + '</span>';
    html += '</div></div>';
  }
  grid.innerHTML = html;
}

function viewResult(id) {
  selectedId = id;
  var c = candidates.find(function(x) { return x.id === id; });
  if (!c || !c.analysis) return;
  document.getElementById('detailTitle').textContent = c.id + ' ë¶„ì„ ê²°ê³¼';
  document.getElementById('detailSub').textContent = c.position + ' | ' + c.interviewType + ' ë©´ì ‘';
  var analysis = c.analysis;
  var html = '';
  for (var i = 0; i < analysis.competencies.length; i++) {
    var comp = analysis.competencies[i];
    html += '<div class="analysis-section">';
    html += '<h3>â–¶ ' + comp.name + '</h3>';
    html += '<h4 style="color:#10B981;font-weight:600;margin-bottom:0.75rem;">âœ“ ê°•ì </h4>';
    for (var j = 0; j < comp.strengths.length; j++) {
      var s = comp.strengths[j];
      html += '<div style="margin-bottom:1rem;padding-left:1rem;"><div>' + (j + 1) + '. ' + s.point + '</div>';
      html += '<div class="evidence" style="border-color:#10B981;">[ê·¼ê±°] ' + s.evidence + '</div></div>';
    }
    html += '<h4 style="color:#F59E0B;font-weight:600;margin:1rem 0 0.75rem;">â–³ ê°œì„ ì </h4>';
    for (var j = 0; j < comp.improvements.length; j++) {
      var im = comp.improvements[j];
      html += '<div style="margin-bottom:1rem;padding-left:1rem;"><div>' + (j + 1) + '. ' + im.point + '</div>';
      html += '<div class="evidence" style="border-color:#F59E0B;">[ê·¼ê±°] ' + im.evidence + '</div></div>';
    }
    html += '</div>';
  }
  html += '<div style="padding:1.5rem;background:linear-gradient(135deg,rgba(59,130,246,0.1),rgba(139,92,246,0.1));border-radius:12px;border:1px solid rgba(59,130,246,0.2);">';
  html += '<h3 style="color:#A78BFA;margin-bottom:1rem;">ã€ ì¢…í•© ì˜ê²¬ ã€‘</h3>';
  html += '<p style="line-height:1.8;color:#ccc;">' + analysis.overallComment + '</p></div>';
  document.getElementById('analysisContent').innerHTML = html;
  document.getElementById('resultDetail').style.display = 'block';
  renderResults();
  showTab('results');
  document.querySelector('[onclick="showTab(\'results\')"]').classList.add('active');
}

// ë‹¤ìš´ë¡œë“œ
function downloadOne(format) {
  var c = candidates.find(function(x) { return x.id === selectedId; });
  if (!c || !c.analysis) return;
  var content = buildContent(c);
  if (format === 'word') {
    var html = '<html><head><meta charset="utf-8"></head><body style="font-family:ë§‘ì€ ê³ ë”•;line-height:1.6;"><pre style="white-space:pre-wrap;">' + content + '</pre></body></html>';
    downloadFile(html, 'ë©´ì ‘ë¶„ì„_' + c.id + '.doc', 'application/msword');
  } else {
    downloadFile(content, 'ë©´ì ‘ë¶„ì„_' + c.id + '.txt', 'text/plain');
  }
}

function downloadAll() {
  var completed = candidates.filter(function(c) { return c.status === STATUS.COMPLETED; });
  if (completed.length === 0) return;
  for (var i = 0; i < completed.length; i++) {
    var c = completed[i];
    var content = buildContent(c);
    downloadFile(content, 'ë©´ì ‘ë¶„ì„_' + c.id + '.txt', 'text/plain');
  }
}

function buildContent(c) {
  var a = c.analysis;
  var s = 'ë©´ì ‘ ë¶„ì„ ê²°ê³¼\n\n';
  s += 'ë©´ì ‘ë²ˆí˜¸: ' + c.id + '\n';
  s += 'ì§€ì›ì§ë¬´: ' + c.position + '\n';
  s += 'ë©´ì ‘í˜•ì‹: ' + c.interviewType + '\n';
  s += 'ë¶„ì„ì¼ì‹œ: ' + new Date().toLocaleString('ko-KR') + '\n\n';
  s += 'â€» ë³¸ ë¶„ì„ì€ AIê°€ ì‘ì„±í•œ ì°¸ê³  ìë£Œì…ë‹ˆë‹¤.\n\n';
  s += '==================================================\n\n';
  for (var i = 0; i < a.competencies.length; i++) {
    var comp = a.competencies[i];
    s += 'ã€ ' + comp.name + ' ã€‘\n\n';
    s += 'â–¶ ê°•ì \n';
    for (var j = 0; j < comp.strengths.length; j++) {
      s += (j + 1) + '. ' + comp.strengths[j].point + '\n   [ê·¼ê±°] ' + comp.strengths[j].evidence + '\n\n';
    }
    s += 'â–¶ ê°œì„ ì \n';
    for (var j = 0; j < comp.improvements.length; j++) {
      s += (j + 1) + '. ' + comp.improvements[j].point + '\n   [ê·¼ê±°] ' + comp.improvements[j].evidence + '\n\n';
    }
    s += '--------------------------------------------------\n\n';
  }
  s += 'ã€ ì¢…í•© ì˜ê²¬ ã€‘\n\n' + a.overallComment;
  return s;
}

function downloadFile(content, filename, mime) {
  var blob = new Blob([content], { type: mime + ';charset=utf-8' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

// ì•Œë¦¼
function showAlert(type, msg) {
  var area = document.getElementById('alertArea');
  var id = 'alert-' + Date.now();
  var icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'âš ï¸';
  area.innerHTML = '<div id="' + id + '" class="alert alert-' + type + '"><span>' + icon + '</span><pre style="margin:0;white-space:pre-wrap;font-family:inherit;flex:1;">' + msg + '</pre><button onclick="document.getElementById(\'' + id + '\').remove()" style="background:none;border:none;cursor:pointer;color:inherit;">âœ•</button></div>';
  if (type !== 'error') setTimeout(function() { var el = document.getElementById(id); if (el) el.remove(); }, 3000);
}
</script>
</body>
</html>
